<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planner | Mapa</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.9);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);column-gap:10px;row-gap:14px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.white{background:#fff;border:3px solid #ccc;color:transparent}
.seat.white::after{border-color:#ccc}
.seat.blocked{background:#6b6b6b;border-color:#6b6b6b;color:#fff!important;cursor:not-allowed}
.seat.selected{background:#e74c3c;border-color:#e74c3c}
.empty{background:transparent}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:rgba(0,0,0,.1);z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
</style>
</head>
<body>

<div id="bus-wrapper">
    <div class="bus-container">
        <button id="confirmarBtn">CONFIRMAR</button>
    </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q = (s,d=document)=>d.querySelector(s);
let selectedSeat=null, blockedSeats=[], reservedByCPF=[];
const progressBar=q("#progress-bar"), progressContainer=q("#progress-bar-container");

const fetchJSON = async url => { try { const r=await fetch(url); return r.ok?await r.json().catch(()=>null):null; } catch{return null;} }
const validarCPF = cpf => { cpf=cpf.replace(/\D/g,'').padStart(11,'0'); if(cpf.length!==11||/^(\d)\1+$/.test(cpf)) return false; let s=0,r=0; for(let i=0;i<9;i++) s+=cpf[i]*(10-i); r=(s*10)%11; if(r==10) r=0; if(r!=cpf[9]) return false; s=0; for(let i=0;i<10;i++) s+=cpf[i]*(11-i); r=(s*10)%11; if(r==10) r=0; return r==cpf[10]; }

const createSeat = v => { 
    const e=document.createElement("div"); 
    e.className = v===null?"empty":v==="white"?"seat white":"seat"; 
    if(v!=="white" && v!==null) e.textContent = v.toString().padStart(2,"0"); 
    return e;
};

const animateProgress = t => { let w=parseFloat(progressBar.style.width)||0; const step=()=>{if(w<t){ w+=.5; progressBar.style.width=w+"%"; requestAnimationFrame(step);} }; step(); }

const renderGrid = layout => {
    const g=document.createElement("div");
    g.className="grid";
    layout.flat().forEach(seat=>{
        const e=createSeat(seat);
        if(seat!==null && seat!=="white"){
            const num=seat.toString().padStart(2,"0");
            if(blockedSeats.includes(num)) e.classList.add("blocked");
            else e.onclick=()=>selectSeat(e);
        }
        g.appendChild(e);
    });
    q(".bus-container").appendChild(g);
};

const selectSeat = e => {
    if(e.classList.contains("blocked")) return;
    if(selectedSeat) selectedSeat.classList.remove("selected");
    e.classList.toggle("selected");
    selectedSeat = e.classList.contains("selected")?e:null;
}

const renderSeats = async () => {
    let [busId, curso] = location.hash.slice(1).split("/"); 
    busId = busId||"0052"; curso = curso||"";
    animateProgress(40);
    const cfg = await fetchJSON(`./configs/${busId}.json`);
    if(!cfg){ alert("Erro ao carregar layout."); return; }
    animateProgress(70);

    if(curso){
        const res=await fetchJSON("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA");
        const rows=res?.poltronas||[];
        blockedSeats=rows.filter(x=>x.CURSO===curso).map(x=>x.ID.padStart(2,"0"));
        reservedByCPF=rows.map(x=>x.CPF2);
    }

    animateProgress(100);
    renderGrid(cfg.layout);
    setTimeout(()=>progressContainer.remove(),600);
    q("#bus-wrapper").style.display="block";
}

q("#confirmarBtn").onclick = async () => {
    if(!selectedSeat) return alert("Selecione uma poltrona.");
    let cpf;
    while(true){
        cpf=prompt("CPF (somente números)");
        if(cpf===null) return;
        cpf=cpf.replace(/\D/g,'').padStart(11,'0');
        if(validarCPF(cpf)) break;
        alert("CPF inválido. Tente novamente.");
    }
    if(reservedByCPF.includes(cpf)) return alert("Usuário possui uma poltrona reservada.");

    try{
        const r=await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1b4f6536a25d47d5909b9ccac943a5e8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=naqfy45S_5sWJoEHTCKIBUbvFpViVRGz4KOXMuyIffw", 
        {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({poltrona:selectedSeat.textContent, CURSO:curso, cpf})});
        if(r.ok){alert("Poltrona selecionada com sucesso!"); setTimeout(()=>location.reload(),2500);}
        else alert("Erro ao encaminhar os dados.");
    }catch(err){console.error(err); alert("Erro de comunicação.");}
}

renderSeats();
</script>
</body>
</html>
