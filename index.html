<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Ã”nibus</title>
<style>
  body { font-family: Arial, sans-serif; }
  #bus-wrapper { position: relative; display: inline-block; }
  #bus-container { display: grid; gap: 6px; padding: 20px; background: #f2f2f2; }
  .seat { width: 38px; height: 38px; background: #4CAF50; color: #fff; display:flex; justify-content:center; align-items:center; border-radius:4px; font-size:14px; cursor:pointer; }
  .blocked { background:#888 !important; cursor:not-allowed; }
  .white { background:transparent !important; cursor:default; }
  #confirmarBtn { position:absolute; padding:12px 22px; font-size:16px; cursor:pointer; border-radius:8px; border:none; background:#007bff; color:white; }
</style>
</head>
<body>
<div id="bus-wrapper">
    <div id="bus-container"></div>
    <button id="confirmarBtn">CONFIRMAR</button>
</div>

<script>
async function loadJSON(url) {
    const r = await fetch(url);
    return await r.json();
}

const params = new URLSearchParams(window.location.search);
const bus = params.get("bus") || "0050";
const turma = params.get("turma") || "";

let config = null;
let blocked = [];

async function init() {
    config = await loadJSON(`https://script.google.com/macros/s/AKfycbzw5N1tcOyFvwy3xNmPR9U1N9xqwiHjT1Efv-V_AHM/dev?bus=${bus}`);
    blocked = turma ? await loadJSON(`https://script.google.com/macros/s/AKfycbzK1b3QfnN8O3NAu7nL2_f_peI6MqkRTxXGFKMcK0ho/dev?curso=${turma}`) : [];
    renderSeats();
}

function renderSeats() {
    const container = document.getElementById("bus-container");
    const wrapper = document.getElementById("bus-wrapper");
    const button = document.getElementById("confirmarBtn");

    container.style.gridTemplateColumns = `repeat(${config.layout[0].length}, 40px)`;
    container.innerHTML = "";

    const blockedNumbers = blocked.map(s => s.poltrona);

    config.layout.forEach(row => {
        row.forEach(num => {
            const el = document.createElement("div");

            if (num === null) {
                el.className = "seat white";
            } else {
                el.className = "seat";
                el.textContent = num.toString().padStart(2, "0");

                if (blockedNumbers.includes(num)) el.classList.add("blocked");
            }
            container.appendChild(el);
        });
    });

    setTimeout(() => {
        const containerRect = container.getBoundingClientRect();
        const wrapperRect = wrapper.getBoundingClientRect();

        button.style.top = (containerRect.height + 20) + "px";
        button.style.left = (containerRect.width - button.offsetWidth) + "px";
    }, 50);
}

init();
</script>
</body>
</html>
